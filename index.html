<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock P/B Calculator (Pure JS)</title>
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; padding-top: 50px; }
        .card { box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .result-box { display: none; margin-top: 20px; }
        .loading { display: none; }
        .metric-value { font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h4 class="mb-0">Stock P/B Calculator</h4>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="stockCode" class="form-label">Stock Code (A-Share)</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="stockCode" placeholder="e.g. 600519" maxlength="6">
                                <button class="btn btn-success" onclick="fetchStockData()">query</button>
                            </div>
                            <div class="form-text">Supports Shanghai (6), Shenzhen (0/3), Beijing (4/8)</div>
                        </div>
                    </div>
                </div>

                <div id="loading" class="text-center mt-3 loading">
                    <div class="spinner-border text-success" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>

                <div id="resultBox" class="card result-box">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="card-title mb-0" id="stockName">--</h5>
                            <span class="badge bg-secondary" id="stockCodeDisplay">--</span>
                        </div>
                        <hr>
                        <div class="row text-center mb-2">
                            <div class="col-4">
                                <div class="text-muted small">Current Price</div>
                                <div class="h4 metric-value" id="priceVal">--</div>
                            </div>
                            <div class="col-4">
                                <div class="text-muted small">P/B Ratio</div>
                                <div class="h4 text-danger metric-value" id="pbVal">--</div>
                            </div>
                            <div class="col-4">
                                <div class="text-muted small">P/E Ratio</div>
                                <div class="h4 metric-value" id="peVal">--</div>
                            </div>
                        </div>
                        <div class="text-end text-muted small mt-2">Latest: <span id="updateTime">--</span></div>
                    </div>
                </div>
                
                <div id="errorBox" class="alert alert-danger mt-3" style="display:none;"></div>
            </div>
        </div>
    </div>

    <script>
        let pollTimer = null;

        function fetchStockData() {
            startPolling();
        }

        function startPolling() {
            const codeInput = document.getElementById('stockCode');
            const code = codeInput.value.trim();
            
            if (!code || !/^\d{6}$/.test(code)) {
                showError('Please enter a valid 6-digit stock code.');
                return;
            }

            // Stop any existing timer
            if (pollTimer) {
                clearInterval(pollTimer);
                pollTimer = null;
            }

            // Reset UI for initial load
            hideError();
            document.getElementById('resultBox').style.display = 'none';
            document.getElementById('loading').style.display = 'block';

            // Initial fetch
            updateData(code, true);

            // Start 5s interval
            pollTimer = setInterval(() => {
                updateData(code, false);
            }, 5000);
        }

        function updateData(code, isFirstLoad) {
            // Determine Market (0: SZ/BJ, 1: SH)
            const market = code.startsWith('6') ? '1' : '0';
            const secid = `${market}.${code}`;

            // API Parameters
            const fields = 'f57,f58,f43,f167,f162';
            const timestamp = new Date().getTime();
            const url = `http://push2.eastmoney.com/api/qt/stock/get?secid=${secid}&ut=fa5fd1943c7b386f172d6893dbfba10b&fields=${fields}&invt=2&fltt=2&vol=2&_=${timestamp}`;

            jsonp(url, function(data) {
                if (isFirstLoad) {
                    document.getElementById('loading').style.display = 'none';
                }
                
                if (!data || !data.data) {
                    if (isFirstLoad) {
                        showError('Failed to fetch data or invalid stock code.');
                        if (pollTimer) clearInterval(pollTimer); // Stop polling on invalid code
                    }
                    return;
                }

                const d = data.data;
                const formatVal = (val) => {
                    if (val === '-' || val === undefined || val === null) return '--';
                    return (val * 1).toFixed(2);
                };

                const name = d.f58 || '--';
                const stockCodeResult = d.f57 || code;
                const price = formatVal(d.f43);
                const pb = formatVal(d.f167);
                const pe = formatVal(d.f162);

                document.getElementById('stockName').innerText = name;
                document.getElementById('stockCodeDisplay').innerText = stockCodeResult;
                document.getElementById('priceVal').innerText = price === '--' ? '--' : `Â¥${price}`;
                document.getElementById('pbVal').innerText = pb;
                document.getElementById('peVal').innerText = pe;

                // Update time
                const now = new Date();
                const timeStr = now.toLocaleTimeString();
                const elTime = document.getElementById('updateTime');
                if(elTime) elTime.innerText = timeStr;

                if (isFirstLoad) {
                    document.getElementById('resultBox').style.display = 'block';
                }
            });
        }

        // JSONP Implementation
        function jsonp(url, callback) {
            const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
            window[callbackName] = function(data) {
                delete window[callbackName];
                document.body.removeChild(script);
                callback(data);
            };

            const script = document.createElement('script');
            script.src = url + (url.indexOf('?') >= 0 ? '&' : '?') + 'cb=' + callbackName;
            script.onerror = function() {
                delete window[callbackName];
                document.body.removeChild(script);
                document.getElementById('loading').style.display = 'none';
                showError('Network Request Failed.');
            };
            document.body.appendChild(script);
        }

        function showError(msg) {
            const el = document.getElementById('errorBox');
            el.innerText = msg;
            el.style.display = 'block';
        }

        function hideError() {
            document.getElementById('errorBox').style.display = 'none';
        }
        
        // Enter key support
        document.getElementById('stockCode').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                fetchStockData();
            }
        });
    </script>
</body>
</html>
